<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>UBOS â€¢ Tide Guide Dashboard</title>
  <style>
    :root {
      --bg1: #001219;
      --bg2: #0a9396;
      --bg3: #94d2bd;
      --card: rgba(255, 255, 255, 0.06);
      --accent: #00c2b2;
      --text: #e9fbf8;
      --muted: #a7c4bf;
      --warn: #ffb703;
      --err: #ef476f;
      --ok: #06d6a0;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }
    body {
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text);
      background: radial-gradient(1200px 800px at 20% -10%, rgba(10,147,150,0.35), transparent 60%),
                  radial-gradient(1000px 700px at 120% -20%, rgba(148,210,189,0.25), transparent 60%),
                  linear-gradient(180deg, var(--bg1), #003049 40%, #002135 100%);
    }
    header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 18px 24px; border-bottom: 1px solid rgba(255,255,255,0.08);
      backdrop-filter: blur(6px);
    }
    .title { font-weight: 700; letter-spacing: 0.5px; font-size: 18px; opacity: 0.95; }
    .controls { display: flex; gap: 12px; align-items: center; }
    button, .pill {
      background: var(--card); color: var(--text); border: 1px solid rgba(255,255,255,0.08);
      padding: 8px 12px; border-radius: 10px; cursor: pointer; transition: 120ms ease-in-out;
    }
    button:hover { border-color: rgba(255,255,255,0.18); transform: translateY(-1px); }
    .pill { font-size: 12px; opacity: 0.9; }

    main { padding: 22px; max-width: 1280px; margin: 0 auto; }
    .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }
    .card {
      background: var(--card); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 16px;
      box-shadow: 0 8px 26px rgba(0,0,0,0.28), inset 0 1px 0 rgba(255,255,255,0.03);
    }
    .card h3 { margin: 0 0 8px 0; font-size: 14px; color: var(--muted); font-weight: 600; letter-spacing: 0.3px; }
    .metric { font-size: 28px; font-weight: 800; letter-spacing: 0.3px; }
    .row { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    .spark { width: 100%; height: 42px; }
    .badge { font-size: 11px; padding: 4px 8px; border-radius: 999px; background: rgba(255,255,255,0.08); }
    .ok { color: var(--ok); }
    .warn { color: var(--warn); }
    .err { color: var(--err); }

    .section { margin-top: 24px; }
    .section h2 { font-size: 16px; margin: 0 0 10px 0; color: var(--muted); font-weight: 700; }
    .list { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .item { background: var(--card); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 12px; font-size: 13px; }
    .muted { color: var(--muted); }
  </style>
</head>
<body>
  <header>
    <div class="title">ðŸŒŠ UBOS â€¢ Tide Guide Dashboard</div>
    <div class="controls">
      <div id="statusPill" class="pill">Startingâ€¦</div>
      <button id="refreshBtn">Refresh</button>
    </div>
  </header>

  <main>
    <div class="grid">
      <div class="card">
        <h3>CITIZENS ACTIVE</h3>
        <div class="row"><div id="citizensMetric" class="metric">â€”</div><div class="badge">24h</div></div>
        <svg id="citizensSpark" class="spark"></svg>
      </div>
      <div class="card">
        <h3>AGENTS â€¢ RUNS</h3>
        <div class="row"><div id="agentsMetric" class="metric">â€”</div><div id="agentsHealth" class="badge">â€”</div></div>
        <svg id="agentsSpark" class="spark"></svg>
      </div>
      <div class="card">
        <h3>MEMORY â€¢ NOTES</h3>
        <div class="row"><div id="notesMetric" class="metric">â€”</div><div class="badge">KB</div></div>
        <svg id="notesSpark" class="spark"></svg>
      </div>
      <div class="card">
        <h3>FUNDING OPPORTUNITIES</h3>
        <div class="row"><div id="oppsMetric" class="metric">â€”</div><div id="phaseBadge" class="badge">â€”</div></div>
        <svg id="oppsSpark" class="spark"></svg>
      </div>
    </div>

    <div class="section">
      <h2>Recent Alerts</h2>
      <div id="alerts" class="list"></div>
    </div>
  </main>

  <script>
    const qs = new URLSearchParams(location.search);
    const PORT = qs.get('port') || '3000';
    const api = (p) => `http://localhost:${PORT}${p}`;

    const state = {
      citizens: [], agents: [], notes: [], opps: []
    };

    async function fetchStatus() {
      const res = await fetch(api('/api/status'));
      if (!res.ok) throw new Error('status failed');
      return res.json();
    }
    async function fetchAlerts() {
      const res = await fetch(api('/api/alerts'));
      if (!res.ok) return [];
      return res.json();
    }

    function setPill(text, cls) {
      const el = document.getElementById('statusPill');
      el.textContent = text;
      el.className = 'pill' + (cls ? ' ' + cls : '');
    }

    function sparkline(svg, data, color = 'var(--accent)') {
      const W = svg.clientWidth || 240; const H = svg.clientHeight || 42; svg.setAttribute('viewBox', `0 0 ${W} ${H}`);
      if (!data || data.length === 0) { svg.innerHTML = ''; return; }
      const min = Math.min(...data), max = Math.max(...data);
      const norm = data.map((v, i) => [i / (data.length - 1 || 1) * (W - 8) + 4, H - 6 - ((v - min) / (max - min || 1)) * (H - 12)]);
      const d = 'M ' + norm.map(([x, y]) => `${x.toFixed(1)} ${y.toFixed(1)}`).join(' L ');
      svg.innerHTML = `<path d="${d}" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round"/>`;
    }

    function updateUI(status, alerts) {
      // Basic metrics
      const activeAgents = status.system.agents.active || 0;
      const completed = status.system.agents.completed || 0;
      const notes = status.system.memory.notes || 0;
      const opps = status.eufmProject?.fundingOpportunities || 0;
      const phase = status.eufmProject?.phase || 'â€”';
      const progress = status.eufmProject?.progress || 0;

      // Citizens approximation (derive from actions): use completed runs for now
      const citizensActive = Math.max(1, Math.floor(completed / 2));

      document.getElementById('citizensMetric').textContent = citizensActive;
      document.getElementById('agentsMetric').textContent = `${activeAgents} / ${completed}`;
      document.getElementById('agentsHealth').textContent = `prog ${progress}%`;
      document.getElementById('notesMetric').textContent = notes;
      document.getElementById('oppsMetric').textContent = opps;
      document.getElementById('phaseBadge').textContent = phase;

      // Generate faux trend data from counts
      const mk = (n) => Array.from({length: 24}, (_, i) => Math.max(0, Math.round(n + (Math.sin(i/2)+Math.random()-0.5)*n*0.15)));
      sparkline(document.getElementById('citizensSpark'), mk(citizensActive));
      sparkline(document.getElementById('agentsSpark'), mk(activeAgents + completed * 0.5));
      sparkline(document.getElementById('notesSpark'), mk(notes || 1));
      sparkline(document.getElementById('oppsSpark'), mk(opps || 1));

      // Alerts
      const list = document.getElementById('alerts');
      list.innerHTML = '';
      (alerts || []).slice(-6).reverse().forEach(a => {
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `<div><strong>${a.level?.toUpperCase?.() || 'INFO'}</strong> â€” ${a.message}</div><div class="muted">${new Date(a.timestamp||Date.now()).toLocaleString()}</div>`;
        list.appendChild(div);
      });
    }

    async function refresh() {
      try {
        setPill('Refreshingâ€¦');
        const [status, alerts] = await Promise.all([fetchStatus(), fetchAlerts()]);
        updateUI(status, alerts);
        setPill('Live', 'ok');
      } catch (e) {
        console.error(e);
        setPill('Offline', 'err');
      }
    }

    document.getElementById('refreshBtn').addEventListener('click', refresh);
    refresh();
    setInterval(refresh, 15000);
  </script>
</body>
</html>

